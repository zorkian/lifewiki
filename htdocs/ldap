<%perl>
    $title = "Login via LDAP";
    if ($remote) {
        print "You are already logged in.";
        return;
    }

    # require a post for this
    if ($did_post) {
        my $data = LifeWiki::Auth::tryVerify($r);
        unless (defined $data) {
            # if it falls through, something failed
            print "<p>Error: invalid username or password.</p>";
            print "<p>$@</p>" if $@;
            return;
        }

        my $u = LifeWiki::User->newFromUser($data->{name});
        unless (defined $u) {
            $u = LifeWiki::User->createAccount(
                username => $data->{name},
                password => undef, # ldap has no passwords on our end
                nickname => $data->{nick},
                email => $data->{email},
            );
            unless (defined $u) {
                print "<p>Error: unable to access your account.  Please try again later.</p>";
                return;
            }
        }

        # must be good
        my $sess = $u->generateSession;
        my $c = Apache::Cookie->new($r,
            -name => 'session',
            -value => $u->getUsername . ":" . $sess . ":",
            -domain => $LifeWiki::DOMAIN,
            -expires => '+1d',
        );
        $c->bake;
    
        # ghetto?
        $remote = $u;

        print "<p>You have been successfully logged in.</p>";
        return;
    }
</%perl>

<form method='post'>
<table><tr><td>Username:</td><td><input type="text" name="username"></td></tr>
<tr><td>Password:</td><td><input type="password" name="password"></td></tr>
<tr><td></td><td><input type="submit" value="Login"></td></tr>
</table>
</form>
